---
title: "20171109CelegansCellLineageComparison"
author: "Xiaolong Cao"
date: "2017Äê11ÔÂ9ÈÕ"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:\\Users\\ATPs\\OneDrive\\Lab\\YangLab\\YangLabSharedProject_Xiaolong\\Celegans\\Lineages")
```

# Analysis of the embryonic tree alignments of C. elegans
## current working directory and load packages
```{r check working directory and load packages}
getwd()
library(ggplot2)
library(dplyr)
```

## files to use
```{r files to use}
fname.referenceTree = "fun.alm"
fname.symmetry = "symmetry-sisters.csv"
fname.alignments = "fun.alml"
```

## read the reference complete tree nodes in `fname.referenceTree` to a dataframe
```{r read reference complete tree nodes }
ReadInputTree <- function(filename){
  return(read.table(filename,sep = '\t',header = TRUE, as.is = TRUE, colClasses = "character", quote = ''))
}
referenceTree = ReadInputTree(fname.referenceTree)
head(referenceTree)
summary(referenceTree)
```

## read the symetric siter cells file `fname.symmetry` to a list and remove duplicates
duplicates means pairs of (Sister1, Sister2) and (Sister2, Sister1)

### Note: an error in line 33 were corrected. the pair should be "ABalpapa,ABarappa", not "ABalpaaa,ABarappa", otherwishe there are three "ABalpaaa" in the file.
```{r read symmetry sister cells}
symmetryCells <- read.table(fname.symmetry, sep = ',', header = TRUE, as.is = TRUE, colClasses = "character")
head(symmetryCells)
dim(symmetryCells)
symmetryCells.unique <- symmetryCells
symmetryCells.verse <- symmetryCells
colnames(symmetryCells.verse) <- colnames(symmetryCells)[c(2,1,4,3)]
symmetryCells.pairs <- rbind(symmetryCells, symmetryCells.verse)
symmetryCells.unique <- symmetryCells.pairs[!duplicated(paste(symmetryCells.pairs$Sister1_binary,symmetryCells.pairs$Sister2_binary, ' ')),]
dim(symmetryCells.unique)
```


## read the Tree alignment file `fname.alignments` to a list
```{r read the Tree alignment file}
ReadTreeAlignments <- function(filename){
  # read the TreeAlignmentFile, return a data.frame. convert the numeric values.
  f.lines <- readLines(filename)
  f.length <- length(f.lines)
  t.count <- f.length %/% 13
  alignments <- read.csv(col.names = c("id","Score","RootS","RootT","PruneS","PruneT","MatchS", "MatchT","Random","Random.min","Random.max","Random.avg","pvalue"),text = "")
  for (i in 1:t.count){
    l <- i * 9 - 9
    id <- i
    for (j in 1:8){
      alignments[i,j] = f.lines[l+j]
    }
  }
  for (i in 1:t.count){
    l <- 9 * t.count + 4 * i - 4
    alignments[i, "Random"] <- f.lines[l+2]
    alignments[i, "Random.min"] <- strsplit(strsplit(f.lines[l+3], ' ')[[1]][1],':')[[1]][2]
    alignments[i, "Random.max"] <- strsplit(strsplit(f.lines[l+3], ' ')[[1]][2],':')[[1]][2]
    alignments[i, "Random.avg"] <- strsplit(strsplit(f.lines[l+3], ' ')[[1]][3],':')[[1]][2]
    alignments[i, "pvalue"] <- strsplit(strsplit(f.lines[l+3], ' ')[[1]][4],':')[[1]][2]
  }
  
  alignments$id <- sub('{','',alignments$id,fixed = TRUE)
  alignments$Score <- sub('Score:', '', alignments$Score, fixed = TRUE)
  alignments$RootS <- sub('RootS:', '', alignments$RootS, fixed = TRUE)
  alignments$RootT <- sub('RootT:', '', alignments$RootT, fixed = TRUE)
  alignments$PruneS <- strsplit(sub('PruneS:', '', alignments$PruneS, fixed = TRUE), ' ')
  alignments$PruneT <- strsplit(sub('PruneT:', '', alignments$PruneT, fixed = TRUE), ' ')
  alignments$MatchS <- strsplit(sub('MatchS:', '', alignments$MatchS, fixed = TRUE), ' ')
  alignments$MatchT <- strsplit(sub('MatchT:', '', alignments$MatchT, fixed = TRUE), ' ')
  alignments$Random <- strsplit(sub('PValue:', '', alignments$Random, fixed = TRUE), ' ')
  
  alignments$Score <- as.numeric(alignments$Score)
  for (i in 1:t.count){
    alignments$Random[[i]] <- as.numeric(alignments$Random[[i]])
  }
  alignments$Random.min <- as.numeric(alignments$Random.min)
  alignments$Random.max <- as.numeric(alignments$Random.max)
  alignments$Random.avg <- as.numeric(alignments$Random.avg)
  alignments$pvalue <- as.numeric(alignments$pvalue)
  
  return(alignments)
}
alignments <- ReadTreeAlignments(fname.alignments)
dim(alignments)
colnames(alignments)
```


## histogram of selected Randomized Tree scores
```{r histogram of selected Randomized Trees}

selected = seq(1,100,20)
for (i in selected){
  randomScore = alignments$Random[[i]]
  print(ggplot(as.data.frame(randomScore), aes(x = randomScore)) 
        + geom_histogram(binwidth = 2) 
        + ggtitle(paste("Alignment:",i,"TreeST:",alignments$RootS[i], alignments$RootT[i],"Avg:",alignments$Random.avg[i],"Score:",alignments$Score[i], "pvalue:",alignments$pvalue[i], sep = " ")))
}

```

## sort based on pvalue
```{r sort based on pvalue}
alignments.orderP <- arrange(alignments, pvalue)
plot(-log(alignments.orderP$pvalue), ylab = "-log(pvalue)", main = "sorted based on pvalue")
```

## count number of symmetry pairs
```{r count number of symmetry pairs}
# CountSymmety
sym1 <- symmetryCells.unique$Sister1_binary
sym2 <- symmetryCells.unique$Sister2_binary
sym.pairs <- paste(sym1, sym2)
for (i in 1:dim(alignments.orderP)[1]){
  MatchS <- alignments.orderP$MatchS[[i]]
  MatchT <- alignments.orderP$MatchT[[i]]
  matchPairs <- data.frame(MatchS, MatchT,stringsAsFactors=FALSE)
  matchLength <- length(MatchS)
  matchPairs.asChr <- paste(MatchS, MatchT)
  symPairs <- matchPairs[matchPairs.asChr %in% sym.pairs,]
  symPairsL <- dim(symPairs)[1]
  alignments.orderP[i,"matchLength"] <- matchLength
  alignments.orderP[i,"symPairsL"] <- symPairsL
  if (symPairsL != 0)
    alignments.orderP[i,"symPairs"][[1]] <- list(symPairs)
  
}
print(alignments.orderP$matchLength)
print(alignments.orderP$symPairsL)
plot(alignments.orderP$symPairsL, ylab = "symmetry pairs", main = "number of symmetry pairs in aligned subTrees")
```

## do Fisher's Exact Test based on number of symmetric pairs
```{r Fisher Exact Test}
totalNodes <- 1340
fisherTestPvalue <- function(testFeature,testTotal,totalFeature, totalTotal){
  x1 <- testFeature
  x2 <- testTotal - x1
  y1 <- totalFeature - testFeature
  y2 <- totalTotal - x1 - x2 - y1
  if (y2<0){
    return(1)
  }
  testMatrix <- matrix(c(x1,y1,x2,y2), ncol = 2, nrow = 2)
  return(fisher.test(testMatrix, alternative = "greater")$p.value)
}
alignments.orderP$fisherP <- apply(alignments.orderP,1, function(x){fisherTestPvalue(x$symPairsL, x$matchLength^2, 60, totalNodes^2)})

plot(alignments.orderP$fisherP,ylab = "p-value", main = "fisher's enrichment p-value in alignments ordered by alignment-p-value")
```





